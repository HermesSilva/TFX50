//<auto-generated/>
using System;
using System.Linq;
using System.Collections.Generic;
using System.Diagnostics;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Logging;
using TFX.Core;
using TFX.Core.Model;
using TFX.Core.Services;
using TFX.Core.Reflections;
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;
using Microsoft.Extensions.DependencyInjection;
using TFX.Core.Exceptions;
using Microsoft.AspNetCore.Http;
using System.Data;
using TFX.Core.Lzma;
using TFX.Core.Identity;
using System.Text;
using Projecao.Core.ERP.Empresa.Rules;
using Projecao.Core.ERP.Empresa;

namespace Projecao.Core.ERP.Empresa
{
    [XGuid("10AC1863-69A1-4E82-9C5D-1281E5C3AE4F", typeof(IEmpresaService))]
    public class EmpresaService : XService, IEmpresaService
    {
        public class ERPxPessoaJuridica : XEntity
        {
            [Display(Name = "Estado")]
            [Required()]
            public Int16 CORxStatusID {get; set;}

            public Boolean IsPKEmpty => !ERPxPessoaJuridicaID.HasValue;
            [Display(Name = "Pessoa Jurídica")]
            [Required()]
            public Guid? ERPxPessoaJuridicaID {get; set;}

            [Display(Name = "Razão Social")]
            [MaxLength(160)]
            [Required()]
            public String RazaoSocial {get; set;}


            public CORxPessoa CORxPessoa {get; set;}
        }
        public class ERPxDocumento : XEntity
        {
            [Display(Name = "Pessoas")]
            [Required()]
            public Guid CORxPessoaID {get; set;}

            [Display(Name = "Estado")]
            [Required()]
            public Int16 CORxStatusID {get; set;}

            public Boolean IsPKEmpty => !ERPxDocumentoID.HasValue;
            [Display(Name = "Documento")]
            [Required()]
            public Guid? ERPxDocumentoID {get; set;}

            [Display(Name = "Tipo de Documento")]
            [Required()]
            public Int16 ERPxDocumentoTipoID {get; set;}

            [Display(Name = "Número")]
            [MaxLength(25)]
            [Required()]
            public String Numero {get; set;}


            public CORxPessoa CORxPessoa {get; set;}
        }
        public class CORxPessoa : XEntity
        {
            [Display(Name = "Localidade")]
            [Required()]
            public Int32 CEPxLocalidadePrincipalID {get; set;}

            public Boolean IsPKEmpty => !CORxPessoaID.HasValue;
            [Display(Name = "Pessoa")]
            [Required()]
            public Guid? CORxPessoaID {get; set;}

            [MaxLength(180)]
            [Required()]
            public String Nome {get; set;}


            public List<CORxAgregado> CORxAgregado {get; set;} = new List<CORxAgregado>();

            public List<ERPxPessoaJuridica> ERPxPessoaJuridica {get; set;} = new List<ERPxPessoaJuridica>();

            public List<ERPxDocumento> ERPxDocumento {get; set;} = new List<ERPxDocumento>();
        }
        public class CORxAgregado : XEntity
        {
            public Boolean IsPKEmpty => !CORxAgregadoID.HasValue;
            [Display(Name = "Agregado")]
            [Required()]
            public Guid? CORxAgregadoID {get; set;}

            [Display(Name = "Estado")]
            [Required()]
            public Int16 CORxStatusID {get; set;}

            [Display(Name = "CPF ou CNPJ")]
            [MaxLength(14)]
            [DisplayFormat(DataFormatString = "###.###.###-##|##.###.###/####-##")]
            [Required()]
            public String CPFCNPJ {get; set;}


            public CORxPessoa CORxPessoa {get; set;}
        }
        public class ERPxDocumentoTipo : XEntity
        {
            public Boolean IsPKEmpty => Object.Equals(ERPxDocumentoTipoID, typeof(Int16).GetDefault());
            [Display(Name = "Tipo de Documento")]
            [Required()]
            [DatabaseGenerated(DatabaseGeneratedOption.None)]
            public Int16 ERPxDocumentoTipoID {get; set;}

            [Required()]
            public Int32 Filtro {get; set;}

            [Display(Name = "Máscara")]
            [MaxLength(30)]
            public String Mascara {get; set;}

            [Display(Name = "Tipo de Documento")]
            [MaxLength(25)]
            [Required()]
            public String Tipo {get; set;}

        }
        public class ERPxContato : XEntity
        {
            [Display(Name = "E-Mail, Telefone e ETC.")]
            [MaxLength(50)]
            [Required()]
            public String Contato {get; set;}

            [Display(Name = "Pessoas")]
            [Required()]
            public Guid CORxPessoaID {get; set;}

            [Display(Name = "Estado")]
            [Required()]
            public Int16 CORxStatusID {get; set;}

            public Boolean IsPKEmpty => !ERPxContatoID.HasValue;
            [Display(Name = "Meios de Contato")]
            [Required()]
            public Guid? ERPxContatoID {get; set;}

            [Display(Name = "Tipo de Contato")]
            [Required()]
            public Int16 ERPxContatoTipoID {get; set;}

            [Display(Name = "Finalidade")]
            [Required()]
            public Int16 ERPxFinalidadeID {get; set;}

            [Display(Name = "Observação")]
            [MaxLength(30)]
            public String Observacao {get; set;}

            [Required()]
            public Boolean Validado {get; set;}

        }
        public class ERPxContatoTipo : XEntity
        {
            public Boolean IsPKEmpty => Object.Equals(ERPxContatoTipoID, typeof(Int16).GetDefault());
            [Display(Name = "Tipo de Contato")]
            [Required()]
            [DatabaseGenerated(DatabaseGeneratedOption.None)]
            public Int16 ERPxContatoTipoID {get; set;}

            [Display(Name = "Máscara")]
            [MaxLength(128)]
            public String Mascara {get; set;}

            [MaxLength(20)]
            [Required()]
            public String Tipo {get; set;}

        }
        public class ERPxFinalidade : XEntity
        {
            public Boolean IsPKEmpty => Object.Equals(ERPxFinalidadeID, typeof(Int16).GetDefault());
            [Display(Name = "Finalidade")]
            [Required()]
            [DatabaseGenerated(DatabaseGeneratedOption.None)]
            public Int16 ERPxFinalidadeID {get; set;}

            [MaxLength(30)]
            [Required()]
            public String Finalidade {get; set;}

        }
        public class ERPxEndereco : XEntity
        {
            [Display(Name = "Logradouro")]
            [Required()]
            public Int32 CEPxLogradouroID {get; set;}

            [MaxLength(30)]
            public String Complemento {get; set;}

            [Display(Name = "Pessoas")]
            [Required()]
            public Guid CORxPessoaID {get; set;}

            [Display(Name = "Estado")]
            [Required()]
            public Int16 CORxStatusID {get; set;}

            public Boolean IsPKEmpty => !ERPxEnderecoID.HasValue;
            [Display(Name = "Endereço")]
            [Required()]
            public Guid? ERPxEnderecoID {get; set;}

            [Display(Name = "Finalidade")]
            [Required()]
            public Int16 ERPxFinalidadeID {get; set;}

            [Required()]
            public Decimal Latitude {get; set;}

            [Required()]
            public Decimal Longitude {get; set;}

            [MaxLength(4)]
            public String Lote {get; set;}

            [Display(Name = "Número")]
            [MaxLength(10)]
            public String Numero {get; set;}

            [Display(Name = "Observação")]
            [MaxLength(50)]
            public String Observacao {get; set;}

            [MaxLength(4)]
            public String Quadra {get; set;}

        }
        public class CEPxUF : XEntity
        {
            [Display(Name = "CEP Final")]
            [MaxLength(8)]
            [Required()]
            public String CEPFinal {get; set;}

            [Display(Name = "CEP Inicial")]
            [MaxLength(8)]
            [Required()]
            public String CEPInicial {get; set;}

            [Display(Name = "País")]
            [Required()]
            public Int16 CEPxPaisID {get; set;}

            public Boolean IsPKEmpty => Object.Equals(CEPxUFID, typeof(Int16).GetDefault());
            [Display(Name = "UF")]
            [Required()]
            [DatabaseGenerated(DatabaseGeneratedOption.None)]
            public Int16 CEPxUFID {get; set;}

            [Display(Name = "Nome da UF")]
            [MaxLength(45)]
            [Required()]
            public String Nome {get; set;}

            [Display(Name = "Sigla da UF")]
            [MaxLength(2)]
            [Required()]
            public String Sigla {get; set;}

        }
        public class CEPxLocalidade : XEntity
        {
            [Display(Name = "CEP Geral")]
            [MaxLength(8)]
            public String CEPGeral {get; set;}

            public Boolean IsPKEmpty => Object.Equals(CEPxLocalidadeID, typeof(Int32).GetDefault());
            [Display(Name = "Localidade")]
            [Required()]
            [DatabaseGenerated(DatabaseGeneratedOption.None)]
            public Int32 CEPxLocalidadeID {get; set;}

            [Display(Name = "Tipo de Localidade")]
            [Required()]
            public Int16 CEPxLocalidadeTipoID {get; set;}

            [Display(Name = "Município")]
            [Required()]
            public Int32 CEPxMunicipioID {get; set;}

            [Display(Name = "Unidade Federativa")]
            [Required()]
            public Int16 CEPxUFID {get; set;}

            [Display(Name = "Código no IBGE")]
            [MaxLength(7)]
            [DisplayFormat(DataFormatString = "0000000")]
            public String CodigoIBGE {get; set;}

            [Display(Name = "Nome da Localidade")]
            [MaxLength(128)]
            [Required()]
            public String Nome {get; set;}

            [Display(Name = "Número")]
            [Required()]
            public Int32 Numero {get; set;}

        }
        public class CEPxLogradouro : XEntity
        {
            [MaxLength(8)]
            [DisplayFormat(DataFormatString = "00.000-000")]
            public String CEP {get; set;}

            [Display(Name = "Bairro")]
            [Required()]
            public Int32 CEPxBairroID {get; set;}

            [Display(Name = "Localidade")]
            [Required()]
            public Int32 CEPxLocalidadeID {get; set;}

            public Boolean IsPKEmpty => Object.Equals(CEPxLogradouroID, typeof(Int32).GetDefault());
            [Display(Name = "Logradouro")]
            [Required()]
            [DatabaseGenerated(DatabaseGeneratedOption.None)]
            public Int32 CEPxLogradouroID {get; set;}

            [MaxLength(128)]
            [Required()]
            public String Nome {get; set;}

            [Display(Name = "Número")]
            [Required()]
            public Int32 Numero {get; set;}

            [MaxLength(30)]
            [Required()]
            public String Tipo {get; set;}

        }
        public class CEPxBairro : XEntity
        {
            [Display(Name = "Abreviatura")]
            [MaxLength(25)]
            public String Breviatura {get; set;}

            public Boolean IsPKEmpty => Object.Equals(CEPxBairroID, typeof(Int32).GetDefault());
            [Display(Name = "Bairro")]
            [Required()]
            [DatabaseGenerated(DatabaseGeneratedOption.None)]
            public Int32 CEPxBairroID {get; set;}

            [Display(Name = "Localidade")]
            [Required()]
            public Int32 CEPxLocalidadeID {get; set;}

            [MaxLength(128)]
            [Required()]
            public String Nome {get; set;}

            [Display(Name = "Número")]
            [Required()]
            public Int32 Numero {get; set;}

        }
        public class DBContext : XDBContext
        {
            public DBContext(DbContextOptions<DBContext> pOptions, XITenantProvider pTenantProvider, XISharedTransaction pSharedTransaction)
                   : base(pOptions, pTenantProvider, pSharedTransaction)
            {
            }

            public DbSet<ERPxPessoaJuridica> ERPxPessoaJuridica{get; set;}
            public DbSet<ERPxDocumento> ERPxDocumento{get; set;}
            public DbSet<CORxPessoa> CORxPessoa{get; set;}
            public DbSet<CORxAgregado> CORxAgregado{get; set;}
            public DbSet<ERPxDocumentoTipo> ERPxDocumentoTipo{get; set;}
            public DbSet<ERPxContato> ERPxContato{get; set;}
            public DbSet<ERPxContatoTipo> ERPxContatoTipo{get; set;}
            public DbSet<ERPxFinalidade> ERPxFinalidade{get; set;}
            public DbSet<ERPxEndereco> ERPxEndereco{get; set;}
            public DbSet<CEPxUF> CEPxUF{get; set;}
            public DbSet<CEPxLocalidade> CEPxLocalidade{get; set;}
            public DbSet<CEPxLogradouro> CEPxLogradouro{get; set;}
            public DbSet<CEPxBairro> CEPxBairro{get; set;}

        private void ConfigureERPxPessoaJuridica(ModelBuilder pBuilder)
        {
            pBuilder.Entity<ERPxPessoaJuridica>(ett =>
            {
                ett.HasKey(e => e.ERPxPessoaJuridicaID).HasName("PK_ERPxPessoaJuridica");

                ett.Property(d => d.ERPxPessoaJuridicaID).HasColumnType(GetDBType("Guid"));
                ett.Property(d => d.CORxStatusID).HasColumnType(GetDBType("Int16"))
                    .HasDefaultValue(GetDBValue("Int16", (Int16)0));
                ett.Property(d => d.RazaoSocial).HasColumnType(GetDBType("String", 160))
                    .HasDefaultValue(GetDBValue("String", @"NI"));
                ett.ToTable("ERPxPessoaJuridica");
                ett.HasOne(d => d.CORxPessoa)
                   .WithMany(p => p.ERPxPessoaJuridica)
                   .HasForeignKey(d => d.ERPxPessoaJuridicaID)
                   .OnDelete(DeleteBehavior.Restrict);
            });
        }
        private void ConfigureERPxDocumento(ModelBuilder pBuilder)
        {
            pBuilder.Entity<ERPxDocumento>(ett =>
            {
                ett.HasKey(e => e.ERPxDocumentoID).HasName("PK_ERPxDocumento");

                ett.Property(d => d.ERPxDocumentoID).HasColumnType(GetDBType("Guid"));
                ett.Property(d => d.ERPxDocumentoTipoID).HasColumnType(GetDBType("Int16"));
                ett.Property(d => d.CORxPessoaID).HasColumnType(GetDBType("Guid"));
                ett.Property(d => d.Numero).HasColumnType(GetDBType("String", 25));
                ett.Property(d => d.CORxStatusID).HasColumnType(GetDBType("Int16"))
                    .HasDefaultValue(GetDBValue("Int16", (Int16)0));
                ett.ToTable("ERPxDocumento");
                ett.HasOne(d => d.CORxPessoa)
                   .WithMany(p => p.ERPxDocumento)
                   .HasForeignKey(d => d.CORxPessoaID)
                   .OnDelete(DeleteBehavior.Restrict);
            });
        }
        private void ConfigureCORxPessoa(ModelBuilder pBuilder)
        {
            pBuilder.Entity<CORxPessoa>(ett =>
            {
                ett.HasKey(e => e.CORxPessoaID).HasName("PK_CORxPessoa");

                ett.Property(d => d.CORxPessoaID).HasColumnType(GetDBType("Guid"));
                ett.Property(d => d.Nome).HasColumnType(GetDBType("String", 180));
                ett.Property(d => d.CEPxLocalidadePrincipalID).HasColumnType(GetDBType("Int32"));
                ett.ToTable("CORxPessoa");
            });
        }
        private void ConfigureCORxAgregado(ModelBuilder pBuilder)
        {
            pBuilder.Entity<CORxAgregado>(ett =>
            {
                ett.HasKey(e => e.CORxAgregadoID).HasName("PK_CORxAgregado");

                ett.Property(d => d.CORxAgregadoID).HasColumnType(GetDBType("Guid"));
                ett.Property(d => d.CORxStatusID).HasColumnType(GetDBType("Int16"));
                ett.Property(d => d.CPFCNPJ).HasColumnType(GetDBType("String", 14));
                ett.ToTable("CORxAgregado");
                ett.HasOne(d => d.CORxPessoa)
                   .WithMany(p => p.CORxAgregado)
                   .HasForeignKey(d => d.CORxAgregadoID)
                   .OnDelete(DeleteBehavior.Restrict);
            });
        }
        private void ConfigureERPxDocumentoTipo(ModelBuilder pBuilder)
        {
            pBuilder.Entity<ERPxDocumentoTipo>(ett =>
            {
                ett.HasKey(e => e.ERPxDocumentoTipoID).HasName("PK_ERPxDocumentoTipo");

                ett.Property(d => d.Tipo).HasColumnType(GetDBType("String", 25));
                ett.Property(d => d.ERPxDocumentoTipoID).HasColumnType(GetDBType("Int16"));
                ett.Property(d => d.Mascara).HasColumnType(GetDBType("String", 30)).IsRequired(false);
                ett.Property(d => d.Filtro).HasColumnType(GetDBType("Int32"));
                ett.ToTable("ERPxDocumentoTipo");
            });
        }
        private void ConfigureERPxContato(ModelBuilder pBuilder)
        {
            pBuilder.Entity<ERPxContato>(ett =>
            {
                ett.HasKey(e => e.ERPxContatoID).HasName("PK_ERPxContato");

                ett.Property(d => d.Contato).HasColumnType(GetDBType("String", 50));
                ett.Property(d => d.CORxPessoaID).HasColumnType(GetDBType("Guid"));
                ett.Property(d => d.ERPxContatoID).HasColumnType(GetDBType("Guid"));
                ett.Property(d => d.ERPxContatoTipoID).HasColumnType(GetDBType("Int16"));
                ett.Property(d => d.ERPxFinalidadeID).HasColumnType(GetDBType("Int16"));
                ett.Property(d => d.CORxStatusID).HasColumnType(GetDBType("Int16"))
                    .HasDefaultValue(GetDBValue("Int16", (Int16)0));
                ett.Property(d => d.Validado).HasColumnType(GetDBType("Boolean"))
                    .HasDefaultValue(GetDBValue("Boolean", false));
                ett.Property(d => d.Observacao).HasColumnType(GetDBType("String", 30)).IsRequired(false);
                ett.ToTable("ERPxContato");
            });
        }
        private void ConfigureERPxContatoTipo(ModelBuilder pBuilder)
        {
            pBuilder.Entity<ERPxContatoTipo>(ett =>
            {
                ett.HasKey(e => e.ERPxContatoTipoID).HasName("PK_ERPxContatoTipo");

                ett.Property(d => d.Tipo).HasColumnType(GetDBType("String", 20));
                ett.Property(d => d.ERPxContatoTipoID).HasColumnType(GetDBType("Int16"));
                ett.Property(d => d.Mascara).HasColumnType(GetDBType("String", 128)).IsRequired(false);
                ett.ToTable("ERPxContatoTipo");
            });
        }
        private void ConfigureERPxFinalidade(ModelBuilder pBuilder)
        {
            pBuilder.Entity<ERPxFinalidade>(ett =>
            {
                ett.HasKey(e => e.ERPxFinalidadeID).HasName("PK_ERPxFinalidade");

                ett.Property(d => d.Finalidade).HasColumnType(GetDBType("String", 30));
                ett.Property(d => d.ERPxFinalidadeID).HasColumnType(GetDBType("Int16"));
                ett.ToTable("ERPxFinalidade");
            });
        }
        private void ConfigureERPxEndereco(ModelBuilder pBuilder)
        {
            pBuilder.Entity<ERPxEndereco>(ett =>
            {
                ett.HasKey(e => e.ERPxEnderecoID).HasName("PK_ERPxEndereco");

                ett.Property(d => d.CORxPessoaID).HasColumnType(GetDBType("Guid"));
                ett.Property(d => d.ERPxEnderecoID).HasColumnType(GetDBType("Guid"));
                ett.Property(d => d.CORxStatusID).HasColumnType(GetDBType("Int16"))
                    .HasDefaultValue(GetDBValue("Int16", (Int16)0));
                ett.Property(d => d.Lote).HasColumnType(GetDBType("String", 4)).IsRequired(false)
                    .HasDefaultValue(GetDBValue("String", null));
                ett.Property(d => d.Quadra).HasColumnType(GetDBType("String", 4)).IsRequired(false)
                    .HasDefaultValue(GetDBValue("String", null));
                ett.Property(d => d.Numero).HasColumnType(GetDBType("String", 10)).IsRequired(false)
                    .HasDefaultValue(GetDBValue("String", null));
                ett.Property(d => d.ERPxFinalidadeID).HasColumnType(GetDBType("Int16"));
                ett.Property(d => d.Observacao).HasColumnType(GetDBType("String", 50)).IsRequired(false);
                ett.Property(d => d.CEPxLogradouroID).HasColumnType(GetDBType("Int32"));
                ett.Property(d => d.Complemento).HasColumnType(GetDBType("String", 30)).IsRequired(false);
                ett.Property(d => d.Latitude).HasColumnType(GetDBType("Decimal", 20, 10));
                ett.Property(d => d.Longitude).HasColumnType(GetDBType("Decimal", 20, 10));
                ett.ToTable("ERPxEndereco");
            });
        }
        private void ConfigureCEPxUF(ModelBuilder pBuilder)
        {
            pBuilder.Entity<CEPxUF>(ett =>
            {
                ett.HasKey(e => e.CEPxUFID).HasName("PK_CEPxUF");

                ett.Property(d => d.CEPxUFID).HasColumnType(GetDBType("Int16"));
                ett.Property(d => d.Nome).HasColumnType(GetDBType("String", 45));
                ett.Property(d => d.Sigla).HasColumnType(GetDBType("String", 2));
                ett.Property(d => d.CEPxPaisID).HasColumnType(GetDBType("Int16"));
                ett.Property(d => d.CEPInicial).HasColumnType(GetDBType("String", 8));
                ett.Property(d => d.CEPFinal).HasColumnType(GetDBType("String", 8));
                ett.ToTable("CEPxUF");
            });
        }
        private void ConfigureCEPxLocalidade(ModelBuilder pBuilder)
        {
            pBuilder.Entity<CEPxLocalidade>(ett =>
            {
                ett.HasKey(e => e.CEPxLocalidadeID).HasName("PK_CEPxLocalidade");

                ett.Property(d => d.CEPxLocalidadeID).HasColumnType(GetDBType("Int32"));
                ett.Property(d => d.CEPxUFID).HasColumnType(GetDBType("Int16"));
                ett.Property(d => d.Nome).HasColumnType(GetDBType("String", 128));
                ett.Property(d => d.CEPxMunicipioID).HasColumnType(GetDBType("Int32"));
                ett.Property(d => d.CodigoIBGE).HasColumnType(GetDBType("String", 7)).IsRequired(false);
                ett.Property(d => d.CEPxLocalidadeTipoID).HasColumnType(GetDBType("Int16"));
                ett.Property(d => d.CEPGeral).HasColumnType(GetDBType("String", 8)).IsRequired(false)
                    .HasDefaultValue(GetDBValue("String", null));
                ett.Property(d => d.Numero).HasColumnType(GetDBType("Int32"));
                ett.ToTable("CEPxLocalidade");
            });
        }
        private void ConfigureCEPxLogradouro(ModelBuilder pBuilder)
        {
            pBuilder.Entity<CEPxLogradouro>(ett =>
            {
                ett.HasKey(e => e.CEPxLogradouroID).HasName("PK_CEPxLogradouro");

                ett.Property(d => d.CEPxBairroID).HasColumnType(GetDBType("Int32"));
                ett.Property(d => d.CEPxLogradouroID).HasColumnType(GetDBType("Int32"));
                ett.Property(d => d.Nome).HasColumnType(GetDBType("String", 128));
                ett.Property(d => d.CEPxLocalidadeID).HasColumnType(GetDBType("Int32"));
                ett.Property(d => d.Tipo).HasColumnType(GetDBType("String", 30));
                ett.Property(d => d.Numero).HasColumnType(GetDBType("Int32"));
                ett.Property(d => d.CEP).HasColumnType(GetDBType("String", 8)).IsRequired(false);
                ett.ToTable("CEPxLogradouro");
            });
        }
        private void ConfigureCEPxBairro(ModelBuilder pBuilder)
        {
            pBuilder.Entity<CEPxBairro>(ett =>
            {
                ett.HasKey(e => e.CEPxBairroID).HasName("PK_CEPxBairro");

                ett.Property(d => d.CEPxLocalidadeID).HasColumnType(GetDBType("Int32"));
                ett.Property(d => d.CEPxBairroID).HasColumnType(GetDBType("Int32"));
                ett.Property(d => d.Nome).HasColumnType(GetDBType("String", 128));
                ett.Property(d => d.Breviatura).HasColumnType(GetDBType("String", 25)).IsRequired(false);
                ett.Property(d => d.Numero).HasColumnType(GetDBType("Int32"));
                ett.ToTable("CEPxBairro");
            });
        }

            protected override void OnModelCreating(ModelBuilder pBuilder)
            {
                ConfigureERPxPessoaJuridica(pBuilder);
                ConfigureERPxDocumento(pBuilder);
                ConfigureCORxPessoa(pBuilder);
                ConfigureCORxAgregado(pBuilder);
                ConfigureERPxDocumentoTipo(pBuilder);
                ConfigureERPxContato(pBuilder);
                ConfigureERPxContatoTipo(pBuilder);
                ConfigureERPxFinalidade(pBuilder);
                ConfigureERPxEndereco(pBuilder);
                ConfigureCEPxUF(pBuilder);
                ConfigureCEPxLocalidade(pBuilder);
                ConfigureCEPxLogradouro(pBuilder);
                ConfigureCEPxBairro(pBuilder);
                base.OnModelCreating(pBuilder);
            }

            protected override string GetConnectionString()
            {
                if (ConnectionString != null)
                    return ConnectionString;
                return XEnvironment.Read("SQL_SERVER_TFX", base.GetConnectionString());
            }
        }

        public abstract class BaseINFEmpresaServiceRule : XServiceINFRule<EmpresaService, EmpresaTuple>
        {
            public BaseINFEmpresaServiceRule(EmpresaService pService)
                : base(pService)
            {
            }
            protected DBContext Context
            {
                get;
                private set;
            }
            protected internal virtual T GetWhere<T>(T pQuery)
            {
                return pQuery;
            }
            internal void SetContext(DBContext pContext)
            {
                Context = pContext;
            }

        }

        public EmpresaService(ILogger<XService> pLogger, DBContext pContext)
               :base(pLogger)
        {
            Rule = new EmpresaRule(this);
            _INFRule = new INFEmpresaServiceRule(this);
            Context = pContext;
            _INFRule.SetContext(Context);
        }

        internal XIServiceRule<EmpresaTuple, EmpresaTuple> Rule;
        private INFEmpresaServiceRule _INFRule;

        public override Guid ID => new Guid("10AC1863-69A1-4E82-9C5D-1281E5C3AE4F");

        public DBContext Context
        {
            get;
        }

        public override void GracefullyClose()
        {
            Context.Commit();
        }
        public IQueryable<EmpresaTuple> ExecuteQuery(EmpresaFilter pFilter, Boolean pFull)
        {
            var ctx = Context;
            var query = from CORxPessoa in ctx.CORxPessoa
                        join CORxAgregado in ctx.CORxAgregado on CORxPessoa.CORxPessoaID equals CORxAgregado.CORxAgregadoID
                        join ERPxPessoaJuridica in ctx.ERPxPessoaJuridica on CORxPessoa.CORxPessoaID equals ERPxPessoaJuridica.ERPxPessoaJuridicaID
                        join ERPxDocumento in ctx.ERPxDocumento on CORxPessoa.CORxPessoaID equals ERPxDocumento.CORxPessoaID
                        where ERPxDocumento.ERPxDocumentoTipoID == Projecao.Core.ERP.DB.ERPxModel.ERPxDocumentoTipo.CNPJ
                        select new {ERPxPessoaJuridica, ERPxDocumento, CORxPessoa, CORxAgregado};
            query = _INFRule.GetWhere(query);


            if (pFilter != null)
            {
                if (!pFilter.RazaoSocial.IsEmpty())
                    query = query.Where(q => EF.Functions.Like(q.ERPxPessoaJuridica.RazaoSocial, "%"+pFilter.RazaoSocial+"%"));
            }

            if (!LoadAll)
            {
                if (pFilter?.SkipRows > 0)
                    query = query.Skip(pFilter.SkipRows.Value);

                if (pFilter?.TakeRows > 0)
                    query = query.Take(pFilter.TakeRows.Value);
                else
                    query = query.Take(75);
            }

            var Documento = pFull ? from ERPxDocumento in ctx.ERPxDocumento
                        join ERPxDocumentoTipo in ctx.ERPxDocumentoTipo on ERPxDocumento.ERPxDocumentoTipoID equals ERPxDocumentoTipo.ERPxDocumentoTipoID
                        
                        select new {ERPxDocumento, ERPxDocumentoTipo} : null; 

            var Contato = pFull ? from ERPxContato in ctx.ERPxContato
                        join ERPxContatoTipo in ctx.ERPxContatoTipo on ERPxContato.ERPxContatoTipoID equals ERPxContatoTipo.ERPxContatoTipoID
                        join ERPxFinalidade in ctx.ERPxFinalidade on ERPxContato.ERPxFinalidadeID equals ERPxFinalidade.ERPxFinalidadeID
                        
                        select new {ERPxContato, ERPxContatoTipo, ERPxFinalidade} : null; 

            var Endereco = pFull ? from ERPxEndereco in ctx.ERPxEndereco
                        join ERPxFinalidade in ctx.ERPxFinalidade on ERPxEndereco.ERPxFinalidadeID equals ERPxFinalidade.ERPxFinalidadeID
                        join CEPxLogradouro in ctx.CEPxLogradouro on ERPxEndereco.CEPxLogradouroID equals CEPxLogradouro.CEPxLogradouroID
                        join CEPxLocalidade in ctx.CEPxLocalidade on CEPxLogradouro.CEPxLocalidadeID equals CEPxLocalidade.CEPxLocalidadeID
                        join CEPxUF in ctx.CEPxUF on CEPxLocalidade.CEPxUFID equals CEPxUF.CEPxUFID
                        join CEPxBairro in ctx.CEPxBairro on CEPxLogradouro.CEPxBairroID equals CEPxBairro.CEPxBairroID
                        
                        select new {ERPxEndereco, ERPxFinalidade, CEPxUF, CEPxLocalidade, CEPxLogradouro, CEPxBairro} : null; 

            var qry = query.Select(q => new EmpresaTuple(null,
                             null,
                             q.CORxPessoa.CORxPessoaID,
                             q.CORxPessoa.Nome,
                             q.CORxPessoa.CEPxLocalidadePrincipalID,
                             q.ERPxPessoaJuridica.RazaoSocial,
                             q.ERPxPessoaJuridica.CORxStatusID,
                             q.ERPxDocumento.Numero,
                             pFull ? Contato.Where(q1 => q1.ERPxContato.CORxPessoaID == q.CORxPessoa.CORxPessoaID )
                            .Select(q => new ContatoTuple(false,
                             q.ERPxContato.Contato,
                             q.ERPxContato.ERPxContatoID,
                             q.ERPxContato.ERPxContatoTipoID,
                             q.ERPxContato.Validado,
                             q.ERPxContato.ERPxFinalidadeID,
                             q.ERPxContato.CORxStatusID,
                             q.ERPxContato.CORxPessoaID,
                             q.ERPxContato.Observacao,
                             q.ERPxContatoTipo.Mascara,
                             q.ERPxContatoTipo.Tipo,
                             q.ERPxFinalidade.Finalidade)).ToArray() : null,
                             pFull ? Documento.Where(q2 => q2.ERPxDocumento.CORxPessoaID == q.CORxPessoa.CORxPessoaID )
                            .Select(q => new DocumentoTuple(q.ERPxDocumento.ERPxDocumentoID,
                               q.ERPxDocumento.ERPxDocumentoTipoID,
                               q.ERPxDocumento.Numero,
                               q.ERPxDocumento.CORxStatusID,
                               q.ERPxDocumento.CORxPessoaID,
                               q.ERPxDocumentoTipo.Mascara,
                               q.ERPxDocumentoTipo.Tipo)).ToArray() : null,
                             pFull ? Endereco.Where(q3 => q3.ERPxEndereco.CORxPessoaID == q.CORxPessoa.CORxPessoaID )
                            .Select(q => new EnderecoTuple(q.CEPxLocalidade.Nome,
                              q.ERPxEndereco.CEPxLogradouroID,
                              q.ERPxEndereco.Complemento,
                              q.CEPxLogradouro.Nome,
                              q.CEPxLogradouro.Tipo,
                              q.CEPxLogradouro.CEP,
                              q.CEPxBairro.Nome,
                              q.ERPxEndereco.Longitude,
                              q.ERPxEndereco.Latitude,
                              null,
                              q.CEPxUF.Sigla,
                              q.CEPxUF.Nome,
                              q.CEPxLocalidade.CodigoIBGE,
                              q.ERPxEndereco.ERPxEnderecoID,
                              q.ERPxEndereco.ERPxFinalidadeID,
                              q.ERPxEndereco.Lote,
                              q.ERPxEndereco.Numero,
                              q.ERPxEndereco.Observacao,
                              q.ERPxEndereco.Quadra,
                              q.ERPxEndereco.CORxStatusID,
                              q.ERPxEndereco.CORxPessoaID,
                              q.ERPxFinalidade.Finalidade)).ToArray() : null));
            return qry;
        }

        public EmpresaDataSet Execute(EmpresaFilter pFilter, Boolean pFull)
        {
            _INFRule.InternalBeforeExecute();
            var qry = ExecuteQuery(pFilter, pFull);
            var tuples = qry.ToList();
            tuples = Rule.InternalAfterSelect(tuples);
            _INFRule.InternalAfterExecute(tuples);
            var dataset = new EmpresaDataSet { Tuples = tuples };
            return dataset;
        }

        public object Flush(EmpresaDataSet pDataSet)
        {
            if (pDataSet?.Tuples.Count == 0)
                throw new XUnconformity("Não é permitido Flush sem Tuplas.");
            using (var scope = XEnvironment.Services.CreateScope())
            using (var ctx = scope.ServiceProvider.GetRequiredService<DBContext>())
            {
                Rule?.InternalBeforeFlush(pDataSet.Tuples);

                SetEmpresaValues(ctx, pDataSet);
                ctx.SaveChanges();

                Rule?.InternalAfterFlush(pDataSet.Tuples);

                return XEndPointMessage.Ok;
            }
        }

        private void SetEmpresaValues(DBContext ctx, EmpresaDataSet pDataSet)
        {
            if (pDataSet == null || pDataSet.Tuples == null)
                return;
            foreach (EmpresaTuple stpl in pDataSet.Tuples)
            {
                var sb = new StringBuilder();
                var ERPxPessoaJuridicatpl = new ERPxPessoaJuridica();
                if (stpl.CORxPessoaID.Value != null)
                    ERPxPessoaJuridicatpl.ERPxPessoaJuridicaID = stpl.CORxPessoaID.Value;
                ERPxPessoaJuridicatpl.CORxStatusID = stpl.CORxStatusID.Value;
                ERPxPessoaJuridicatpl.RazaoSocial = stpl.RazaoSocial.Value;
                ERPxPessoaJuridicatpl.Validate(sb);
                ctx.ERPxPessoaJuridica.Add(ERPxPessoaJuridicatpl);
                if (!ERPxPessoaJuridicatpl.IsPKEmpty)
                    ctx.Entry(ERPxPessoaJuridicatpl).State = EntityState.Modified;
                else
                    ctx.Entry(ERPxPessoaJuridicatpl).State = EntityState.Added;

                var CORxPessoatpl = new CORxPessoa();
                if (stpl.CORxPessoaID.Value != null)
                    CORxPessoatpl.CORxPessoaID = stpl.CORxPessoaID.Value;
                CORxPessoatpl.Nome = stpl.Nome.Value;
                CORxPessoatpl.CEPxLocalidadePrincipalID = stpl.CEPxLocalidadePrincipalID.Value;
                CORxPessoatpl.Validate(sb);
                ctx.CORxPessoa.Add(CORxPessoatpl);
                if (!CORxPessoatpl.IsPKEmpty)
                    ctx.Entry(CORxPessoatpl).State = EntityState.Modified;
                else
                    ctx.Entry(CORxPessoatpl).State = EntityState.Added;
                ERPxPessoaJuridicatpl.CORxPessoa = CORxPessoatpl;
                SetDocumentoValues(ctx, stpl.Documento);
                SetContatoValues(ctx, stpl.Contato);
                SetEnderecoValues(ctx, stpl.Endereco);

                void SetDocumentoValues(DBContext ctx, DocumentoTuple[] pTuples)
                {
                    if (pTuples == null)
                        return;
                    foreach (DocumentoTuple stpl in pTuples)
                    {
                        var sb = new StringBuilder();
                        var ERPxDocumentotpl = new ERPxDocumento();
                        if (stpl.ERPxDocumentoID.Value != null)
                            ERPxDocumentotpl.ERPxDocumentoID = stpl.ERPxDocumentoID.Value;
                        ERPxDocumentotpl.ERPxDocumentoTipoID = stpl.ERPxDocumentoTipoID.Value;
                        ERPxDocumentotpl.CORxPessoaID = stpl.CORxPessoaID.Value;
                        ERPxDocumentotpl.Numero = stpl.Numero.Value;
                        ERPxDocumentotpl.CORxStatusID = stpl.CORxStatusID.Value;
                        ERPxDocumentotpl.Validate(sb);
                        ctx.ERPxDocumento.Add(ERPxDocumentotpl);
                        if (!ERPxDocumentotpl.IsPKEmpty)
                            ctx.Entry(ERPxDocumentotpl).State = EntityState.Modified;
                        else
                            ctx.Entry(ERPxDocumentotpl).State = EntityState.Added;
                        if (sb.Length > 0)
                            throw new Exception(sb.ToString());
                    }
                }

                void SetContatoValues(DBContext ctx, ContatoTuple[] pTuples)
                {
                    if (pTuples == null)
                        return;
                    foreach (ContatoTuple stpl in pTuples)
                    {
                        var sb = new StringBuilder();
                        var ERPxContatotpl = new ERPxContato();
                        ERPxContatotpl.Contato = stpl.Contato.Value;
                        ERPxContatotpl.CORxPessoaID = stpl.CORxPessoaID.Value;
                        if (stpl.ERPxContatoID.Value != null)
                            ERPxContatotpl.ERPxContatoID = stpl.ERPxContatoID.Value;
                        ERPxContatotpl.ERPxContatoTipoID = stpl.ERPxContatoTipoID.Value;
                        ERPxContatotpl.ERPxFinalidadeID = stpl.ERPxFinalidadeID.Value;
                        ERPxContatotpl.CORxStatusID = stpl.CORxStatusID.Value;
                        ERPxContatotpl.Validado = stpl.Validado.Value;
                        ERPxContatotpl.Observacao = stpl.Observacao.Value;
                        ERPxContatotpl.Validate(sb);
                        ctx.ERPxContato.Add(ERPxContatotpl);
                        if (!ERPxContatotpl.IsPKEmpty)
                            ctx.Entry(ERPxContatotpl).State = EntityState.Modified;
                        else
                            ctx.Entry(ERPxContatotpl).State = EntityState.Added;
                        if (sb.Length > 0)
                            throw new Exception(sb.ToString());
                    }
                }

                void SetEnderecoValues(DBContext ctx, EnderecoTuple[] pTuples)
                {
                    if (pTuples == null)
                        return;
                    foreach (EnderecoTuple stpl in pTuples)
                    {
                        var sb = new StringBuilder();
                        var ERPxEnderecotpl = new ERPxEndereco();
                        ERPxEnderecotpl.CORxPessoaID = stpl.CORxPessoaID.Value;
                        if (stpl.ERPxEnderecoID.Value != null)
                            ERPxEnderecotpl.ERPxEnderecoID = stpl.ERPxEnderecoID.Value;
                        ERPxEnderecotpl.CORxStatusID = stpl.CORxStatusID.Value;
                        ERPxEnderecotpl.Lote = stpl.Lote.Value;
                        ERPxEnderecotpl.Quadra = stpl.Quadra.Value;
                        ERPxEnderecotpl.Numero = stpl.Numero.Value;
                        ERPxEnderecotpl.ERPxFinalidadeID = stpl.ERPxFinalidadeID.Value;
                        ERPxEnderecotpl.Observacao = stpl.Observacao.Value;
                        ERPxEnderecotpl.CEPxLogradouroID = stpl.CEPxLogradouroID.Value;
                        ERPxEnderecotpl.Complemento = stpl.Complemento.Value;
                        ERPxEnderecotpl.Latitude = stpl.Latitude.Value;
                        ERPxEnderecotpl.Longitude = stpl.Longitude.Value;
                        ERPxEnderecotpl.Validate(sb);
                        ctx.ERPxEndereco.Add(ERPxEnderecotpl);
                        if (!ERPxEnderecotpl.IsPKEmpty)
                            ctx.Entry(ERPxEnderecotpl).State = EntityState.Modified;
                        else
                            ctx.Entry(ERPxEnderecotpl).State = EntityState.Added;
                        if (sb.Length > 0)
                            throw new Exception(sb.ToString());
                    }
                }
                if (sb.Length > 0)
                    throw new Exception(sb.ToString());
            }
        }
    }
}